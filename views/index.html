<!DOCTYPE html>
<html>
<head>
    <!--<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />-->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Welcome to Birdway!</title>
    <link href="/css/home.css" rel="stylesheet" />
    <link href="/lib/artDialog/skins/default.css" rel="stylesheet" />
    <link href="/lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- 请注意JS加载顺序 -->
    <script src="http://api.map.baidu.com/api?v=1.4" type="text/javascript"></script>
    <script type="text/javascript" src="http://developer.baidu.com/map/jsdemo/demo/convertor.js"></script>
    <script src="/js/bmap/custom/testlab.js" type="text/javascript"></script>
    <script src="/js/bmap/lib/MapWrapper.min.js" type="text/javascript"></script>
    <script src="/lib/headjs/head.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        head.js(
//                {baiduapi: "http://api.map.baidu.com/api?v=1.4"},
                {baidumap: "/js/bmap/home_bmap.js"},
                {kissy: "/lib/kissy/kissy-min.js"},
                {jquery: "/lib/jquery/jquery-1.7.2.min.js"},
                {artDialog: "/lib/artDialog/artDialog.min.js"},
                {artDplugins: "/lib/artDialog/artDialog.plugins.min.js"},
                {ejs: "/lib/ejs/ejs_production.js"},
                {blurjs: "/lib/blurjs/blur.min.js"},
                {bootstrap: "/lib/bootstrap/js/bootstrap.min.js"},
                // label is optional
                "/js/home/index.js"
        );

        //    head.js(
        //            "/css/historical_step.css",
        //            "/lib/artDialog/skins/default.css",
        //            "/lib/bootstrap/css/bootstrap.min.css"
        //    );
        //        head.ready(function(){
        //            alert('ready');
        //        });
        //        head.ready(document, function(){
        //            alert(document);
        //        });
        //        head.js("http://api.map.baidu.com/api?v=1.4","/js/map/home_bmap.js", function(){
        //            initmap();
        //        });
        head.ready("baidumap", function(){
            initmap();
        });

    </script>

    <!-- <script src="/js/socket.io.min.js" type="text/javascript"></script> -->
    <script src="/socket.io/socket.io.js" type="text/javascript"></script>
    <script type="text/javascript">
//        var socket = io.connect('http://localhost:8088');  //不知道为什么，只要加上url就连接不上
        var socket = io.connect();
        socket.on('connect', function () {
            socket.emit('uid', { uid: '123' });
//            socket.emit('uid', prompt('What is your nickname?'));
//            socket.on('ready', function () {
//                console.log('Connected !');
//                socket.emit('msg', prompt('What is your message?'));
//            });
        });
        socket.on('news', function (data) {
            console.log(data);
        });

        var point = null;
        var marker = null;
        socket.on('public_points', function(datastr){
            console.log('public_points:'+datastr);
            var data = KISSY.JSON.parse(datastr);
            var id = data.id;
            var gpspoint = KISSY.JSON.parse(data.point);
            var point = new BMap.Point(gpspoint.lng, gpspoint.lat);
            var overlay = OVERLAYS[id];
            if(overlay == undefined || overlay == 'undefined'){
                BMap.Convertor.translate(point, 0, function(bpoint){
                    var myCompOverlay = new CustomOverlay(id, bpoint, "测点ID:"+id);
                    map.addOverlay(myCompOverlay);
                    OVERLAYS[id] = myCompOverlay;
                });
            }else{
                BMap.Convertor.translate(point, 0, function(bpoint){
                    overlay.move(bpoint);
                });
            }

//            var mkrs = map.getOverlays();
//            for (var i=1; i<mkrs.length; i++){
//
//
//            }
//            //坐标转换
//            point = new BMap.Point(data.lon, data.lat);
//            marker = new BMap.Marker(point);        // 创建标注
//            map.addOverlay(marker);
//            console.log(data);
//            socket.emit('my other event', { my: 'data' });
        });

        socket.on('user_point', function(data){
            console.log('user_point:'+data);
            var mkrs = map.getOverlays();
            var myself = null;
            for (var i=1; i<mkrs.length; i++){

            }
            if (myself == null || myself == undefined || myself == 'undefined'){
                //转换gps坐标
                var mapWforGPS = new BMapLib.MapWrapper(map, BMapLib.COORD_TYPE_GPS);
                var gpsMkr = new BMap.Marker(new BMap.Point(data.lon, data.lat)); //要用自定义的Marker
                mapWforGPS.addOverlay(gpsMkr);
            }else{
                myself = mkrs[0];
                //这里要坐标转换
                myself.setPosition(new BMap.Point(data.lon, data.lat));
            }
        });
    </script>

</head>
<body>
<div id="mapdiv_id" ></div>
<div id="map_search_id">
    <form id="road_search_id" class="form-search">
        <input type="text" class="span5">
        <button type="submit" class="btn">搜索</button>
    </form>
</div>
<div id="rightpanel_id">
    <img id="avatar_id" class="img-polaroid" src="/images/notlogin_avatar.png">
    <a class="btn">旅行日志</a>
    <a class="btn" href="/business/travelplan">旅行计划</a>
    <a class="btn" href="/business/historicalstep">历史足迹</a>
    <a class="btn">历史足迹</a>
    <a class="btn">发表文章</a>
    <a class="btn">旅游计划</a>
    <a class="btn">历史足迹</a>
    <a class="btn">历史足迹</a>
    </ul>
</div>
<div id="console_id">
    <div id="myself_id" class="ctrlbut"></div>
    <div id="partner_id" class="ctrlbut"></div>
</div>
</body>
</html>