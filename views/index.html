<!DOCTYPE html>
<html>
<head>
    <!--<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />-->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Welcome to Birdway!</title>
    <link href="/css/home.css" rel="stylesheet" />
    <link href="/lib/artDialog/skins/default.css" rel="stylesheet" />
    <link href="/lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- 请注意JS加载顺序 -->
    <script src="http://api.map.baidu.com/api?v=1.4" type="text/javascript"></script>
    <script src="/js/bmap/lib/MapWrapper.min.js" type="text/javascript"></script>
    <script src="/lib/headjs/head.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        head.js(
//                {baiduapi: "http://api.map.baidu.com/api?v=1.4"},
                {baidumap: "/js/map/home_bmap.js"},
                {jquery: "/lib/jquery/jquery-1.7.2.min.js"},
                {artDialog: "/lib/artDialog/artDialog.min.js"},
                {artDplugins: "/lib/artDialog/artDialog.plugins.min.js"},
                {ejs: "/lib/ejs/ejs_production.js"},
                {blurjs: "/lib/blurjs/blur.min.js"},
                {bootstrap: "/lib/bootstrap/js/bootstrap.min.js"},
                // label is optional
                "/js/home/index.js"
        );

        //    head.js(
        //            "/css/historical_step.css",
        //            "/lib/artDialog/skins/default.css",
        //            "/lib/bootstrap/css/bootstrap.min.css"
        //    );
//        head.ready(function(){
//            alert('ready');
//        });
//        head.ready(document, function(){
//            alert(document);
//        });
//        head.js("http://api.map.baidu.com/api?v=1.4","/js/map/home_bmap.js", function(){
//            initmap();
//        });
        head.ready("baidumap", function(){
//            initmap();
        });

    </script>

    <script src="/socket.io/socket.io.js" type="text/javascript"></script>
    <script type="text/javascript">
        var socket = io.connect('http://127.0.0.1:8088');
        var point = null;
        var marker = null;
        socket.on('public_points', function(data){
            var mkrs = map.getOverlays();
            for (var i=1; i<mkrs.length; i++){


            }
            //坐标转换
            point = new BMap.Point(data.lon, data.lat);
            marker = new BMap.Marker(point);        // 创建标注
            map.addOverlay(marker);
//            console.log(data);
//            socket.emit('my other event', { my: 'data' });
        });
        socket.on('my_point', function(data){
            var mkrs = map.getOverlays();
            var myself = null;
            for (var i=1; i<mkrs.length; i++){

            }
            if (myself == null || myself == undefined || myself == 'undefined'){
                //转换gps坐标
                var mapWforGPS = new BMapLib.MapWrapper(map, BMapLib.COORD_TYPE_GPS);
                var gpsMkr = new BMap.Marker(new BMap.Point(data.lon, data.lat)); //要用自定义的Marker
                mapWforGPS.addOverlay(gpsMkr);
            }else{
                myself = mkrs[0];
                //这里要坐标转换
                myself.setPosition(new BMap.Point(data.lon, data.lat));
            }
        });
    </script>

</head>
<body>
    <div id="mapdiv_id" ></div>
    <div id="map_search_id">
        <form id="road_search_id" class="form-search">
            <input type="text" class="span5">
            <button type="submit" class="btn">搜索</button>
        </form>
    </div>
    <div id="rightpanel_id">
        <img id="avatar_id" class="img-polaroid" src="/images/notlogin_avatar.png">
        <a class="btn">旅行日志</a>
        <a class="btn" href="/business/travelplan">旅行计划</a>
        <a class="btn" href="/business/historicalstep">历史足迹</a>
        <a class="btn">历史足迹</a>
        <a class="btn">发表文章</a>
        <a class="btn">旅游计划</a>
        <a class="btn">历史足迹</a>
        <a class="btn">历史足迹</a>
        </ul>
    </div>
    <div id="console_id">
        <div id="myself_id" class="ctrlbut"></div>
        <div id="partner_id" class="ctrlbut"></div>
    </div>
</body>
</html>